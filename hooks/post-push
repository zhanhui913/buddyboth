set -e

echo '-> Navigate to the repo root'
ROOT=$(git rev-parse --show-cdup)
if [[ '' != $ROOT ]]; then cd $ROOT; fi

echo '-> Check that this is a submodule'
echo `pwd`;
if [ ! -f .git ]; then echo "You must invoke me from inside a submodule."; exit 1; fi

echo '-> Get a reference to the current directory'
DIR=`pwd`
BRANCH=`git rev-parse --abbrev-ref HEAD`

echo '-> Get commit message'

MESSAGE=$( git log -1 HEAD --pretty=format:%s )

echo 'Your last commit message'
echo $MESSAGE
echo 'Will be used'

echo '-> Update supermodule (puffpastry repo) from submodule'
cd ../..

NEW_DIR=`pwd` 
git pull --rebase origin master

echo '-> Commit submodule change into puffpastry repo, in the master branch'
git add $DIR
git commit -m "$MESSAGE"
git push origin master

echo '-> Go back to where you came from'
cd -

git checkout $BRANCH